let port, reader;
function appendLog(t){ const el=document.getElementById('log'); el.textContent += '\n'+t; el.scrollTop = el.scrollHeight; }
document.getElementById('connect').addEventListener('click', async ()=>{ try{ port = await navigator.serial.requestPort(); await port.open({ baudRate: 9600 }); appendLog('Connected to Arduino'); reader = port.readable.getReader(); readLoop(); }catch(e){ appendLog('Connect error: '+e); } });
async function readLoop(){ while(true){ const { value, done } = await reader.read(); if(done) break; const text = new TextDecoder().decode(value).trim(); appendLog('Arduino: '+text); if(text.startsWith('DONE:')){ const parts=text.slice(5).split(',').map(s=>s.trim()); const id=parts[0]; const ABS=Number(parts[1]); const CONC=Number(parts[2]); const TRANS=Number(parts[3]); appendLog('Posting result for '+id); try{ await fetch('/api/result',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,results:{ABS,CONC,TRANS}})}); appendLog('Posted to server'); }catch(e){ appendLog('Post error '+e); } } } }
document.getElementById('test').addEventListener('click', async ()=>{ const id=prompt('Test Patient ID (1001-1010)','1001'); if(!id) return; const ABS=Math.floor(10+Math.random()*15); const CONC=Math.floor(120+Math.random()*80); const TRANS=Math.floor(10+Math.random()*15); appendLog('Simulate DONE:'+id+','+ABS+','+CONC+','+TRANS); try{ await fetch('/api/result',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,results:{ABS,CONC,TRANS}})}); appendLog('Posted simulated result'); }catch(e){ appendLog('Sim post error '+e); } });